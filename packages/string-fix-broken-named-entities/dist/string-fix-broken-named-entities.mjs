/**
 * string-fix-broken-named-entities
 * Finds and fixes common and not so common broken named HTML entities, returns ranges array of fixes
 * Version: 4.0.1
 * Author: Roy Revelt, Codsen Ltd
 * License: MIT
 * Homepage: https://codsen.com/os/string-fix-broken-named-entities/
 */

import e from"leven";import{entStartsWith as t,decode as r,uncertain as n,entEndsWith as a,maxLength as o,allNamedEntitiesSetOnlyCaseInsensitive as l,allNamedEntitiesSetOnly as i,brokenNamedEntities as m}from"all-named-html-entities";import{right as s,rightSeq as c,left as d,leftSeq as u}from"string-left-right";function g(e){return e&&"object"==typeof e&&!Array.isArray(e)}function h(e){return f(e)&&1===e.length&&(e.charCodeAt(0)>96&&123>e.charCodeAt(0)||e.charCodeAt(0)>47&&58>e.charCodeAt(0)||e.charCodeAt(0)>64&&91>e.charCodeAt(0)||35===e.charCodeAt(0))}function p(e){return f(e)&&e.charCodeAt(0)>47&&58>e.charCodeAt(0)}function f(e){return"string"==typeof e}function y(e){return"string"==typeof e&&(e.charCodeAt(0)>96&&123>e.charCodeAt(0)||e.charCodeAt(0)>64&&91>e.charCodeAt(0))}function C(e,t,r){let n=0,a=0,o=0,l=0,i=0,m="",s="";for(let c=t;r>c;c++)e[c].trim().length?s+=e[c]:i+=1,y(e[c])?n+=1:p(e[c])?(a+=1,m+=e[c]+""):"#"===e[c]?l+=1:o+=1;let c=!1;return!n&&a>o?c="deci":(a||n)&&("#"===s[0]&&"x"===s[1].toLowerCase()&&(p(s[2])||y(s[2]))||"x"===s[0].toLowerCase()&&a&&!o)&&(c="hexi"),{probablyNumeric:c,lettersCount:n,numbersCount:a,numbersValue:m,hashesCount:l,othersCount:o,charTrimmed:s,whitespaceCount:i}}function b(e){return Array.isArray(e)&&e.length?1===e.length?e[0]:e.reduce(((e,t)=>t.tempEnt.length>e.tempEnt.length?t:e)):e}function N(e,t){if(2!==arguments.length)throw Error("removeGappedFromMixedCases(): wrong amount of inputs!");let r;return Array.isArray(t)&&t.length&&(r=Array.from(t),r.length>1&&r.some((t=>";"===e[s(e,t.tempRes.rightmostChar)]))&&r.some((t=>";"!==e[s(e,t.tempRes.rightmostChar)]))&&(r=r.filter((t=>";"===e[s(e,t.tempRes.rightmostChar)]))),!r.every((e=>!(e&&e.tempRes&&e.tempRes.gaps&&Array.isArray(e.tempRes.gaps)&&e.tempRes.gaps.length)))&&!r.every((e=>e&&e.tempRes&&e.tempRes.gaps&&Array.isArray(e.tempRes.gaps)&&e.tempRes.gaps.length)))?b(r.filter((e=>!e.tempRes.gaps||!Array.isArray(e.tempRes.gaps)||!e.tempRes.gaps.length))):b(t)}var T="4.0.1";function V(y,b){if("string"!=typeof y)throw Error(`string-fix-broken-named-entities: [THROW_ID_01] the first input argument must be string! It was given as:\n${JSON.stringify(y,null,4)} (${typeof y}-type)`);const T={decode:!1,cb:({rangeFrom:e,rangeTo:t,rangeValEncoded:r,rangeValDecoded:n})=>n||r?[e,t,g(b)&&b.decode?n:r]:[e,t],progressFn:null,entityCatcherCb:null};if(b&&!g(b))throw Error(`string-fix-broken-named-entities: [THROW_ID_02] the second input argument must be a plain object! I was given as:\n${JSON.stringify(b,null,4)} (${typeof b}-type)`);const V={...T,...b};if(V.cb&&"function"!=typeof V.cb)throw new TypeError(`string-fix-broken-named-entities: [THROW_ID_03] opts.cb must be a function (or falsey)! Currently it's: ${typeof V.cb}, equal to: ${JSON.stringify(V.cb,null,4)}`);if(V.entityCatcherCb&&"function"!=typeof V.entityCatcherCb)throw new TypeError(`string-fix-broken-named-entities: [THROW_ID_04] opts.entityCatcherCb must be a function (or falsey)! Currently it's: ${typeof V.entityCatcherCb}, equal to: ${JSON.stringify(V.entityCatcherCb,null,4)}`);if(V.progressFn&&"function"!=typeof V.progressFn)throw new TypeError(`string-fix-broken-named-entities: [THROW_ID_05] opts.progressFn must be a function (or falsey)! Currently it's: ${typeof V.progressFn}, equal to: ${JSON.stringify(V.progressFn,null,4)}`);const w=[];let $,A;const E=y.length+1;let F=0,O=null,R=null,D=null;for(let g=0;E>g;g++){if(V.progressFn&&($=Math.floor(F/E*100),$!==A&&(A=$,V.progressFn($))),O){if(!0===O||O>g){F+=1;continue}O=null}if(null!==R&&g-R>50&&(R=null),null!==R&&(!y[g]||y[g].trim().length&&!h(y[g]))){if(g>R+1){const h=y.slice(R,g),p=d(y,R),b=p?d(y,p):"";if("&"!==y[p]||y[g]&&";"===y[g]){if("&"!==y[p]&&"&"!==y[b]&&";"===y[g]){const e=d(y,g),t=d(y,e);if(null!==t&&Object.prototype.hasOwnProperty.call(a,y[e])&&Object.prototype.hasOwnProperty.call(a[y[e]],y[t])){let o,l,i=a[y[e]][y[t]].reduce(((e,t)=>(l=u(y,g,...t.split("")),!l||"block"===t&&":"===y[d(y,R)]?e:e.concat([{tempEnt:t,tempRes:l}]))),[]);if(i=N(y,i),i&&({tempEnt:o,tempRes:l}=i),o&&(!Object.keys(n).includes(o)||!0===n[o].addAmpIfSemiPresent||n[o].addAmpIfSemiPresent&&(!l.leftmostChar||f(y[l.leftmostChar-1])&&!y[l.leftmostChar-1].trim().length))){const e=r(`&${o};`);w.push({ruleName:"bad-named-html-entity-malformed-"+o,entityName:o,rangeFrom:l.leftmostChar,rangeTo:g+1,rangeValEncoded:`&${o};`,rangeValDecoded:e})}}else null!==D&&(w.push({ruleName:"bad-malformed-numeric-character-entity",entityName:null,rangeFrom:D,rangeTo:g+1,rangeValEncoded:null,rangeValDecoded:null}),D=null)}else if(("&"===y[p]||";"===y[p]&&"&"===y[b])&&";"===y[g]){if(y.slice(p+1,g).trim().length>1){const t=C(y,p+1,g);if(t.probablyNumeric){if(t.probablyNumeric&&"#"===t.charTrimmed[0]&&!t.whitespaceCount&&(!t.lettersCount&&t.numbersCount>0&&!t.othersCount||(t.numbersCount||t.lettersCount)&&"x"===t.charTrimmed[1]&&!t.othersCount)){const e=String.fromCharCode(parseInt(t.charTrimmed.slice("deci"===t.probablyNumeric?1:2),"deci"===t.probablyNumeric?10:16));"deci"===t.probablyNumeric&&parseInt(t.numbersValue,10)>918015?w.push({ruleName:"bad-malformed-numeric-character-entity",entityName:null,rangeFrom:p||0,rangeTo:g+1,rangeValEncoded:null,rangeValDecoded:null}):V.decode&&w.push({ruleName:"encoded-numeric-html-entity-reference",entityName:t.charTrimmed,rangeFrom:p||0,rangeTo:g+1,rangeValEncoded:`&${t.charTrimmed};`,rangeValDecoded:e})}else w.push({ruleName:"bad-malformed-numeric-character-entity",entityName:null,rangeFrom:p||0,rangeTo:g+1,rangeValEncoded:null,rangeValDecoded:null});V.entityCatcherCb&&V.entityCatcherCb(p,g+1)}else{const a=Array.from(h).filter((e=>e.trim().length)).join("");if(o>=a.length&&l.has(a.toLowerCase())){if(i.has(a))if(g-p-1!==a.length||"&"!==y[p]){const e="&"===y[p]?p:b;if(Object.keys(n).includes(a)&&!y[e+1].trim().length){R=null;continue}w.push({ruleName:"bad-named-html-entity-malformed-"+a,entityName:a,rangeFrom:e,rangeTo:g+1,rangeValEncoded:`&${a};`,rangeValDecoded:r(`&${a};`)})}else V.decode?w.push({ruleName:"encoded-html-entity-"+a,entityName:a,rangeFrom:p,rangeTo:g+1,rangeValEncoded:`&${a};`,rangeValDecoded:r(`&${a};`)}):V.entityCatcherCb&&V.entityCatcherCb(p,g+1);else{const e=[...i].filter((e=>e.toLowerCase()===a.toLowerCase()));w.push(1===e.length?{ruleName:"bad-named-html-entity-malformed-"+e[0],entityName:e[0],rangeFrom:p,rangeTo:g+1,rangeValEncoded:`&${e[0]};`,rangeValDecoded:r(`&${e[0]};`)}:{ruleName:"bad-named-html-entity-unrecognised",entityName:null,rangeFrom:p,rangeTo:g+1,rangeValEncoded:null,rangeValDecoded:null})}R=null;continue}R&&s(y,R);let c,d;if(Object.prototype.hasOwnProperty.call(m,t.charTrimmed.toLowerCase())){c=t.charTrimmed;const e=r(`&${m[t.charTrimmed.toLowerCase()]};`);w.push({ruleName:"bad-named-html-entity-malformed-"+m[t.charTrimmed.toLowerCase()],entityName:m[t.charTrimmed.toLowerCase()],rangeFrom:p,rangeTo:g+1,rangeValEncoded:`&${m[t.charTrimmed.toLowerCase()]};`,rangeValDecoded:e})}else o+2>h.length&&((d=[...i].filter((t=>1===e(t,h))))&&d.length||(d=[...i].filter((t=>2===e(t,h)&&h.length>3)))&&d.length)&&1===d.length&&([c]=d,w.push({ruleName:"bad-named-html-entity-malformed-"+c,entityName:c,rangeFrom:p,rangeTo:g+1,rangeValEncoded:`&${c};`,rangeValDecoded:r(`&${c};`)}));c||w.push({ruleName:"bad-named-html-entity-unrecognised",entityName:null,rangeFrom:p,rangeTo:g+1,rangeValEncoded:null,rangeValDecoded:null})}}}else if("&"===y[b]&&";"===y[g]&&o>g-b){const e=C(y,b+1,g);w.push({ruleName:""+(e.probablyNumeric?"bad-malformed-numeric-character-entity":"bad-named-html-entity-unrecognised"),entityName:null,rangeFrom:b,rangeTo:g+1,rangeValEncoded:null,rangeValDecoded:null})}}else{const e=R,a=R?s(y,R):null;if(Object.prototype.hasOwnProperty.call(t,y[e])&&Object.prototype.hasOwnProperty.call(t[y[e]],y[a])){let o,l,i=t[y[e]][y[a]].reduce(((e,t)=>(l=c(y,R-1,...t.split("")),l?e.concat([{tempEnt:t,tempRes:l}]):e)),[]);if(i=N(y,i),i&&({tempEnt:o,tempRes:l}=i),o&&(!Object.keys(n).includes(o)||!y[l.rightmostChar+1]||["&"].includes(y[l.rightmostChar+1])||(!0===n[o].addSemiIfAmpPresent||n[o].addSemiIfAmpPresent&&(!y[l.rightmostChar+1]||!y[l.rightmostChar+1].trim().length))&&"&"===y[l.leftmostChar-1])){const e=r(`&${o};`);w.push({ruleName:"bad-named-html-entity-malformed-"+o,entityName:o,rangeFrom:p||0,rangeTo:l.rightmostChar+1,rangeValEncoded:`&${o};`,rangeValDecoded:e})}}}}R=null}if(null===R&&h(y[g])&&y[g+1]&&(R=g),"a"===y[g]){const e=c(y,g,"m","p",";");if(e){let n=e.rightmostChar+1;const a=c(y,e.rightmostChar,"a","m","p",";");if(a){let e;n=a.rightmostChar+1;do{e=c(y,n-1,"a","m","p",";"),e&&(n=e.rightmostChar+1)}while(e)}const o=s(y,n-1),l=o?s(y,o):null;let i="";if(l&&Object.prototype.hasOwnProperty.call(t,y[o])&&Object.prototype.hasOwnProperty.call(t[y[o]],y[l])&&t[y[o]][y[l]].some((e=>{if(c(y,n-1,...e.split("")))return i=e,!0}))){O=o+i.length+1;const e=d(y,g);if("&"===y[e])w.push({ruleName:"bad-named-html-entity-multiple-encoding",entityName:i,rangeFrom:e||0,rangeTo:O,rangeValEncoded:`&${i};`,rangeValDecoded:r(`&${i};`)});else if(e){const e=g,t="";V.cb&&w.push({ruleName:"bad-named-html-entity-multiple-encoding",entityName:i,rangeFrom:e,rangeTo:O,rangeValEncoded:`${t}&${i};`,rangeValDecoded:`${t}${r(`&${i};`)}`})}}}}"#"!==y[g]||!s(y,g)||"x"!==y[s(y,g)].toLowerCase()||y[g-1]&&d(y,g)&&"&"===y[d(y,g)]||p(y[s(y,s(y,g))])&&(D=g),F+=1}if(!w.length)return[];return w.filter(((e,t)=>w.every(((r,n)=>t===n||!(e.rangeFrom>=r.rangeFrom&&r.rangeTo>e.rangeTo))))).map(V.cb)}export{V as fixEnt,T as version};
