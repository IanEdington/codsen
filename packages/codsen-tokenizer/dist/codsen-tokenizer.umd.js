/**
 * codsen-tokenizer
 * Tokenizer for mixed inputs aiming at broken code, especially HTML & CSS
 * Version: 1.0.0
 * Author: Roy Revelt, Codsen Ltd
 * License: MIT
 * Homepage: https://gitlab.com/codsen/codsen/tree/master/packages/codsen-tokenizer
 */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).codsenTokenizer=e()}(this,(function(){"use strict";function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}var e="[object Object]";var n,r,o=Function.prototype,s=Object.prototype,u=o.toString,l=s.hasOwnProperty,i=u.call(Object),c=s.toString,f=(n=Object.getPrototypeOf,r=Object,function(t){return n(r(t))});var a=function(t){if(!function(t){return!!t&&"object"==typeof t}(t)||c.call(t)!=e||function(t){var e=!1;if(null!=t&&"function"!=typeof t.toString)try{e=!!(t+"")}catch(t){}return e}(t))return!1;var n=f(t);if(null===n)return!0;var r=l.call(n,"constructor")&&n.constructor;return"function"==typeof r&&r instanceof r&&u.call(r)==i};function p(t,e=0){const n=e?t.slice(e):t;let r=!1;return/^<\s*\w+\s*\/?\s*>/g.test(n)?r=!0:/^<\s*\w+\s+\w+\s*=\s*['"]/g.test(n)?r=!0:/^<\s*\/?\s*\w+\s*\/?\s*>/g.test(n)?r=!0:/^<\s*\w+(?:\s*\w+)*\s*\w+=['"]/g.test(n)&&(r=!0),"string"==typeof t&&e<t.length&&r}function g(t){return"string"==typeof t}var h={reportProgressFunc:null,reportProgressFuncFrom:0,reportProgressFuncTo:100},y="{}%-$_()*|";function d(t){for(var e="",n=0,r=t.length;n<r;n++)e="{"===t[n]?"}".concat(e):"("===t[n]?")".concat(e):"".concat(t[n]).concat(e);return e}return function(e,n,r){if(!g(e))throw void 0===e?new Error("html-crush: [THROW_ID_01] the first input argument is completely missing! It should be given as string."):new Error('html-crush: [THROW_ID_02] the first input argument must be string! It was given as "'.concat(t(e),'", equal to:\n').concat(JSON.stringify(e,null,4)));if("function"!=typeof n)throw new Error("html-crush: [THROW_ID_03] the second input argument, callback function, should be a function but it was given as type ".concat(t(n),", equal to ").concat(JSON.stringify(n,null,4)));if(r&&!a(r))throw new Error("html-crush: [THROW_ID_04] the third input argument, options object, should be a plain object but it was given as type ".concat(t(r),", equal to ").concat(JSON.stringify(r,null,4)));var o,s,u=Object.assign({},h,r),l=0,i=e.length,c=Math.floor(i/2),f={},m={type:null,start:null,end:null,tail:null};function b(){f=Object.assign({},m)}b();var v=[];function w(t,e){if(!v.length)return!1;if("simple"===v[v.length-1].type)return t[e]===v[v.length-1].value;if("esp"===v[v.length-1].type){if(!y.includes(t[e]))return!1;for(var n="",r=t.length,o=e;o<r&&y.includes(t[o]);o++)n+=t[o];return v[v.length-1].value.split("").every((function(t){return n.includes(t)}))}}function O(t){n(t),b()}function F(t,e){null!==t.start&&(t.end=e,O(t))}for(var j=0;j<i;j++){if(u.reportProgressFunc&&(i>1e3&&i<2e3?j===c&&u.reportProgressFunc(Math.floor((u.reportProgressFuncTo-u.reportProgressFuncFrom)/2)):i>=2e3&&(o=u.reportProgressFuncFrom+Math.floor(j/i))!==l&&(l=o,u.reportProgressFunc(o))),Number.isInteger(s)&&j>=s&&(s=!1),f.end&&f.end===j&&F(f,j),!s&&["html"].includes(f.type)&&['"',"'"].includes(e[j])&&(w(e,j)?v.pop():v.length&&"esp"===v[v.length-1].type||v.push({type:"simple",value:e[j]})),!s)if(!v.length&&"<"===e[j]&&p(e,j))F(f,j),f.start=j,f.type="html";else if(y.includes(e[j])&&e[j+1]&&y.includes(e[j+1])){for(var P="",S=j;S<i&&y.includes(e[S]);S++)P+=e[S];["html","esp"].includes(f.type)?"html"===f.type&&(w(e,j)?v.pop():v.push({type:"esp",value:d(P)})):(F(f,j),f.start=j,f.type="esp",s=j+P.length,f.tail=d(P))}else null!==f.start&&f.end!==j||(f.end&&O(f),f.start=j,f.type="text");if(!s)if("html"!==f.type||v.length||">"!==e[j]){if("esp"===f.type&&null===f.end&&g(f.tail)&&f.tail.includes(e[j])){for(var _="",I=j;I<i&&y.includes(e[I]);I++)_+=e[I];f.end=j+_.length,s=j+_.length}}else f.end=j+1;e[j+1]||null===f.start||(f.end=j+1,O(f))}}}));
