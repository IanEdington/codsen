/**
 * codsen-parser
 * Parser aiming at broken or mixed code, especially HTML & CSS
 * Version: 0.9.2
 * Author: Roy Revelt, Codsen Ltd
 * License: MIT
 * Homepage: https://codsen.com/os/codsen-parser/
 */

import{pathNext as e,pathUp as o,pathPrev as n}from"ast-monkey-util";import{findMalformed as t}from"string-find-malformed";import{left as l,right as s}from"string-left-right";import{tokenizer as r}from"codsen-tokenizer";import i from"object-path";const g="0.9.2",a={reportProgressFunc:null,reportProgressFuncFrom:0,reportProgressFuncTo:100,tagCb:null,charCb:null,errCb:null};function c(e){return e&&"object"==typeof e&&!Array.isArray(e)}function m(e,o){return console.log("013 layerPending() received: "),console.log(`015 - 1.[33mlayers[39m = ${JSON.stringify(e,null,4)}`),console.log(`022 - 2. [33mtokenObj[39m = ${JSON.stringify(o,null,4)}`),console.log(`029 >>>>>> [33mlayers[layers.length - 1].tagName[39m = ${JSON.stringify(e.length&&c(e[e.length-1])&&e[e.length-1].tagName?e[e.length-1].tagName:null,null,4)}`),console.log(`040 >>>>>> [33mtokenObj.tagName[39m = ${JSON.stringify(o.tagName,null,4)}`),o.closing&&e.length&&(e[e.length-1].type===o.type&&Object.prototype.hasOwnProperty.call(e[e.length-1],"tagName")&&Object.prototype.hasOwnProperty.call(o,"tagName")&&e[e.length-1].tagName===o.tagName&&!1===e[e.length-1].closing||"comment"===o.type&&e.some((e=>Object.prototype.hasOwnProperty.call(e,"closing")&&!e.closing)))}function u(g,u){if("string"!=typeof g)throw void 0===g?new Error("codsen-tokenizer: [THROW_ID_01] the first input argument is completely missing! It should be given as string."):new Error(`codsen-tokenizer: [THROW_ID_02] the first input argument must be string! It was given as "${typeof g}", equal to:\n${JSON.stringify(g,null,4)}`);if(u&&!c(u))throw new Error(`codsen-tokenizer: [THROW_ID_03] the second input argument, an options object, should be a plain object but it was given as type ${typeof u}, equal to ${JSON.stringify(u,null,4)}`);if(u&&c(u)&&u.tagCb&&"function"!=typeof u.tagCb)throw new Error(`codsen-tokenizer: [THROW_ID_04] the opts.tagCb, callback function, should be a function but it was given as type ${typeof u.tagCb}, equal to ${JSON.stringify(u.tagCb,null,4)}`);if(u&&c(u)&&u.charCb&&"function"!=typeof u.charCb)throw new Error(`codsen-tokenizer: [THROW_ID_05] the opts.charCb, callback function, should be a function but it was given as type ${typeof u.charCb}, equal to ${JSON.stringify(u.charCb,null,4)}`);if(u&&c(u)&&u.reportProgressFunc&&"function"!=typeof u.reportProgressFunc)throw new Error(`codsen-tokenizer: [THROW_ID_06] the opts.reportProgressFunc, callback function, should be a function but it was given as type ${typeof u.reportProgressFunc}, equal to ${JSON.stringify(u.reportProgressFunc,null,4)}`);if(u&&c(u)&&u.errCb&&"function"!=typeof u.errCb)throw new Error(`codsen-tokenizer: [THROW_ID_07] the opts.errCb, callback function, should be a function but it was given as type ${typeof u.errCb}, equal to ${JSON.stringify(u.errCb,null,4)}`);const p={...a,...u},d=[],y=[];let f="",h=!1,N={};const O=["tag","comment"],$=["doctype"];return r(g,{reportProgressFunc:p.reportProgressFunc,reportProgressFuncFrom:p.reportProgressFuncFrom,reportProgressFuncTo:p.reportProgressFuncTo,tagCbLookahead:2,tagCb:(r,g)=>{if(console.log("-".repeat(100)),console.log(`247 â–ˆâ–ˆ [33mINCOMING TOKEN[39m:\n${JSON.stringify({type:r.type,tagName:r.tagName,start:r.start,end:r.end,value:r.value,kind:r.kind,closing:r.closing},null,4)}`),console.log(`262 FIY, [33mNEXT[39m = ${JSON.stringify(g,null,4)}`),console.log(`269 FIY, STARTING [33mlayers[39m = ${JSON.stringify(d,null,4)}`),"function"==typeof p.tagCb&&p.tagCb(r),!r.nested){let a=i.get(y,f);if(c(a)||(a=null),console.log(`298 FIY, [33mprevToken[39m = ${JSON.stringify(a,null,4)}`),console.log(`305 FIY, [33mlastProcessedToken[39m = ${JSON.stringify(N,null,4)}`),!h||r.closing||a&&a.tagName===r.tagName&&!a.closing&&r.closing||m(d,r)||g.length&&"text"===r.type&&"tag"===g[0].type&&(g[0].closing&&N.closing||d[d.length-3]&&g[0].tagName!==d[d.length-1].tagName&&"tag"===d[d.length-3].type&&!d[d.length-3].closing&&g[0].tagName===d[d.length-3].tagName))if(r.closing&&"string"==typeof f&&f.includes(".")&&(!r.tagName||N.tagName!==r.tagName||N.closing))if(console.log("365 [35mâ–ˆâ–ˆ UP[39m"),f=e(o(f)),m(d,r)){for(console.log("370 current token was pending, so we pop() it from layers");d.length&&d[d.length-1].type!==r.type&&d[d.length-1].kind!==r.kind;)d.pop();d.pop(),console.log(`388 POP layers, now equals to: ${JSON.stringify(d,null,4)}`),h=!1,console.log(`397 [32mSET[39m [33mnestNext[39m: ${h}`)}else if(console.log(`401 [31mlayer for "${r.value}" was not pending![39m`),console.log("404 [31myet this was a closing token[39m"),d.length>1&&r.tagName&&r.tagName===d[d.length-2].tagName){if(console.log("415 [32mTHIS WAS A GAP[39m"),f=e(o(f)),console.log("421 [35mâ–ˆâ–ˆ UP again[39m"),"function"==typeof p.errCb){const e=d[d.length-1];console.log(`429 [31mâ–ˆâ–ˆ RAISE ERROR[39m ${e.type}${"comment"===e.type?`-${e.kind}`:""}-missing-closing`),p.errCb({ruleId:`${e.type}${"comment"===e.type?`-${e.kind}`:""}-missing-closing`,idxFrom:e.start,idxTo:e.end,tokenObj:e})}d.pop(),d.pop(),console.log(`454 POP layers twice, now equals to: ${JSON.stringify(d,null,4)}`)}else if(d.length>2&&d[d.length-3].type===r.type&&d[d.length-3].type===r.type&&d[d.length-3].tagName===r.tagName){if(console.log("475 [32mPREVIOUS TAG WAS ROGUE OPENING[39m"),f=e(o(f)),console.log("481 [35mâ–ˆâ–ˆ UP again[39m"),"function"==typeof p.errCb){const e=d[d.length-1];console.log(`489 [31mâ–ˆâ–ˆ RAISE ERROR[39m tag-rogue [${e.start}, ${e.end}]`),p.errCb({ruleId:"tag-rogue",idxFrom:e.start,idxTo:e.end,tokenObj:e})}d.pop(),d.pop(),d.pop()}else if(d.length>1&&d[d.length-2].type===r.type&&d[d.length-2].type===r.type&&d[d.length-2].tagName===r.tagName){if(console.log("522 [32mPREVIOUS TAG WAS ROGUE CLOSING[39m"),"function"==typeof p.errCb){const e=d[d.length-1];console.log(`533 [31mâ–ˆâ–ˆ RAISE ERROR[39m tag-rogue [${e.start}, ${e.end}]`),p.errCb({ruleId:"tag-rogue",idxFrom:e.start,idxTo:e.end,tokenObj:e})}d.pop(),d.pop()}else console.log("549 ELSE clauses - TODO");else f?(console.log("565 [35mâ–ˆâ–ˆ BUMP[39m"),f=e(f),m(d,r)&&(d.pop(),console.log(`571 POP layers, now equals to: ${JSON.stringify(d,null,4)}`))):(console.log("560 [35mâ–ˆâ–ˆ FIRST[39m"),f="0");else h=!1,console.log("352 [35mâ–ˆâ–ˆ NEST[39m"),f=`${f}.children.0`;console.log("[90m----------------- path calculations done -----------------[39m"),O.includes(r.type)&&!r.void&&Object.prototype.hasOwnProperty.call(r,"closing")&&!r.closing&&(h=!0,console.log("593 [32mSET[39m [33mnestNext[39m = true"),r.kind&&$.includes(r.kind)||(d.push({...r}),console.log(`599 [32mPUSH[39m to layers, which is now: ${JSON.stringify(d,null,4)}`))),console.log(`609 FIY, [33mpath[39m = ${f}`);const u=n(f)||"",S=o(f);let b,v;console.log(`624 [33mparentPath[39m = ${JSON.stringify(S,null,4)}`),S&&f.includes(".")&&(b=i.get(y,S)),console.log(`636 [33mparentTagsToken[39m at path "[33m${S}[39m" - ${JSON.stringify(b?{...b,children:"..."}:b,null,4)}`),u&&(v=i.get(y,u)),console.log(`650 NOW [33mpreviousTagsToken[39m at path "[33m${u}[39m" - ${JSON.stringify(v,null,4)}`),console.log(`657 FIY, [33mtokenObj.closing[39m = ${JSON.stringify(r.closing,null,4)}`),console.log(`671 [33mres[39m BEFORE: ${JSON.stringify(y,null,4)}`);const E=/(-+|-+[^>])>/;let F,R;c(v)&&Array.isArray(v.children)&&v.children.length&&v.children[v.children.length-1]&&(F=v.children[v.children.length-1],R=`${u}.children.${i.get(y,u).children.length-1}`);let T=!1;if(console.log(`699 FIY, [33mlayers[39m = ${JSON.stringify(d,null,4)}`),"text"===r.type&&c(b)&&"comment"===b.type&&"simple"===b.kind&&!b.closing&&E.test(r.value)){console.log("714 [31mâ–ˆâ–ˆ intervention needed[39m");const n=(E.exec(r.value)||{}).index,t=(n||0)+r.value.slice(n).indexOf(">")+1;console.log(`724 SUSPICIOUS ENDING: [[33msuspiciousEndingStartsAt[39m = ${JSON.stringify(n,null,4)}, [33msuspiciousEndingEndsAt[39m = ${JSON.stringify(t,null,4)}] - value: "${r.value.slice(n,t)}"`),n&&n>0&&(console.log('743 [32mADD[39m text leading up to "->"'),console.log(`746 [33mres[39m BEFORE: ${JSON.stringify(y,null,4)}`),i.set(y,f,{...r,end:r.start+n,value:r.value.slice(0,n)}),O.includes(r.type)&&(r.children=[]),console.log(`761 [33mres[39m AFTER: ${JSON.stringify(y,null,4)}`)),console.log(`772 OLD [33mpath[39m = ${f}`),f=e(o(f)),console.log(`776 NEW [33mpath[39m = ${f}`),i.set(y,f,{type:"comment",kind:"simple",closing:!0,start:r.start+(n||0),end:r.start+t,value:r.value.slice(n,t),children:[]}),console.log(`791 [33mres[39m AFTER: ${JSON.stringify(y,null,4)}`),t<r.value.length&&(console.log(`802 OLD [33mpath[39m = ${f}`),f=e(f),console.log(`806 NEW [33mpath[39m = ${f}`),i.set(y,f,{type:"text",start:r.start+t,end:r.end,value:r.value.slice(t)}),console.log(`815 [33mres[39m AFTER: ${JSON.stringify(y,null,4)}`)),T=!0}else if("comment"===r.type&&"only"===r.kind&&c(v))if(console.log("833 [31mâ–ˆâ–ˆ intervention needed[39m"),"text"===v.type&&v.value.trim()&&"<!-".includes(v.value[l(v.value,v.value.length)])){console.log('854 [31mMALFORMED "NOT" COMMENT[39m');const e=[];if(t(v.value,"\x3c!--",(o=>{e.push(o)}),{maxDistance:2}),console.log(`874 [33mcapturedMalformedTagRanges[39m = ${JSON.stringify(e,null,4)}`),e.length&&!s(v.value,e[e.length-1].idxTo-1)){console.log("889 picking the last malformed range");const o=e.pop();console.log(`895 [33mmalformedRange[39m = ${JSON.stringify(o,null,4)}`),!l(v.value,o.idxFrom)&&u&&c(v)?(console.log("911 whole token is malformed \x3c!--"),O.includes(r.type)&&(r.children=[]),f=u,i.set(y,f,{...r,start:o.idxFrom+v.start,kind:"not",value:`${v.value}${r.value}`}),T=!0):u&&c(v)&&(console.log("931 there are characters in front of \x3c!--"),i.set(y,u,{...v,end:o.idxFrom+v.start,value:v.value.slice(0,o.idxFrom)}),O.includes(r.type)&&(r.children=[]),i.set(y,f,{...r,start:o.idxFrom+v.start,kind:"not",value:`${v.value.slice(o.idxFrom)}${r.value}`}),T=!0)}}else if(c(F)&&"text"===F.type&&F.value.trim()&&"<!-".includes(F.value[l(F.value,F.value.length)])){console.log('980 [31mMALFORMED "NOT" COMMENT[39m');const e=[];if(t(F.value,"\x3c!--",(o=>{e.push(o)}),{maxDistance:2}),console.log(`1000 [33mcapturedMalformedTagRanges[39m = ${JSON.stringify(e,null,4)}`),e.length&&!s(F.value,e[e.length-1].idxTo-1)){console.log("1015 picking the last malformed range");const o=e.pop();console.log(`1021 [33mmalformedRange[39m = ${JSON.stringify(o,null,4)}`),!l(F.value,o.idxFrom)&&u&&c(F)?(console.log("1040 whole token is malformed \x3c!--"),O.includes(r.type)&&(r.children=[]),i.set(y,f,{...r,start:o.idxFrom+F.start,kind:"not",value:`${F.value}${r.value}`}),console.log(`1061 â–ˆâ–ˆ [33mpreviousPath[39m = ${JSON.stringify(u,null,4)}`),console.log(`1068 DELETING TEXT NODE - RES BEFORE: ${JSON.stringify(y,null,4)}`),i.del(y,`${u}.children.${i.get(y,u).children.length-1}`),console.log(`1081 DELETING TEXT NODE - RES AFTER: ${JSON.stringify(y,null,4)}`),T=!0):u&&c(F)&&R&&(console.log("1095 there are characters preceding \x3c!--"),console.log(`1100 FIY, [33mparentsLastChildTokenPath[39m = ${JSON.stringify(R,null,4)}`),i.set(y,R,{...F,end:o.idxFrom+F.start,value:F.value.slice(0,o.idxFrom)}),O.includes(r.type)&&(r.children=[]),i.set(y,f,{...r,start:o.idxFrom+F.start,kind:"not",value:`${F.value.slice(o.idxFrom)}${r.value}`}),T=!0)}}console.log("1140 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ the bottom clauses"),console.log(`1143 FIY, [33mnext[39m = ${JSON.stringify(g,null,4)}`),console.log(`1150 FIY, [33mlayers[39m = ${JSON.stringify(d,null,4)}`),T||(console.log("1159 setting as usual"),O.includes(r.type)&&(r.children=[]),i.set(y,f,r)),console.log(`1167 [33mres[39m AFTER: ${JSON.stringify(y,null,4)}`),console.log(`1175 ENDING [33mpath[39m = ${JSON.stringify(f,null,4)}`),!O.includes(r.type)||!r.closing||u&&c(v)&&!v.closing&&v.type===r.type&&v.tagName===r.tagName||(r.void?(console.log("1197 frontal slash must be removed because it's a void tag"),"function"==typeof p.errCb&&(console.log("1201 [31mâ–ˆâ–ˆ RAISE ERROR tag-void-frontal-slash[39m"),p.errCb({ruleId:"tag-void-frontal-slash",idxFrom:r.start,idxTo:r.end,fix:{ranges:[[r.start+1,r.tagNameStartsAt]]},tokenObj:r}))):(console.log("1214 it's an unpaired tag"),"function"==typeof p.errCb&&(console.log(`1217 [31mâ–ˆâ–ˆ RAISE ERROR[39m ${r.type}${"comment"===r.type?`-${r.kind}`:""}-missing-opening`),p.errCb({ruleId:`${r.type}${"comment"===r.type?`-${r.kind}`:""}-missing-opening`,idxFrom:r.start,idxTo:r.end,tokenObj:r})))),N={...r},console.log("[90m---[39m"),console.log(`[90mâ–ˆâ–ˆ nestNext = [${h?32:31}m${h}[39m[39m`),console.log(`[90mâ–ˆâ–ˆ layers = ${JSON.stringify(d,null,4)}[39m`)}},charCb:p.charCb}),console.log("-".repeat(80)),console.log(`1279 FIY, ENDING [33mlayers[39m = ${JSON.stringify(d,null,4)}`),d.length&&d.forEach((e=>{"function"==typeof p.errCb&&(console.log(`1290 [31mâ–ˆâ–ˆ RAISE ERROR[39m ${e.type}${"comment"===e.type?`-${e.kind}`:""}-missing-closing`),p.errCb({ruleId:`${e.type}${"comment"===e.type?`-${e.kind}`:""}-missing-closing`,idxFrom:e.start,idxTo:e.end,tokenObj:e}))})),console.log(`1309 [32mFINAL RETURN[39m ${JSON.stringify(y,null,4)}`),y}export{u as cparser,a as defaults,g as version};
