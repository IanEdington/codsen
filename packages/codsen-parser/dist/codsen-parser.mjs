/**
 * codsen-parser
 * Parser aiming at broken or mixed code, especially HTML & CSS
 * Version: 0.9.0
 * Author: Roy Revelt, Codsen Ltd
 * License: MIT
 * Homepage: https://codsen.com/os/codsen-parser/
 */

import{pathNext as e,pathUp as t,pathPrev as n}from"ast-monkey-util";import{findMalformed as r}from"string-find-malformed";import{left as o,right as i}from"string-left-right";import{tokenizer as l}from"codsen-tokenizer";import s from"object-path";const a="0.9.0",c={reportProgressFunc:null,reportProgressFuncFrom:0,reportProgressFuncTo:100,tagCb:null,charCb:null,errCb:null};function g(e){return e&&"object"==typeof e&&!Array.isArray(e)}function u(e,t){return t.closing&&e.length&&(e[e.length-1].type===t.type&&Object.prototype.hasOwnProperty.call(e[e.length-1],"tagName")&&Object.prototype.hasOwnProperty.call(t,"tagName")&&e[e.length-1].tagName===t.tagName&&!1===e[e.length-1].closing||"comment"===t.type&&e.some((e=>Object.prototype.hasOwnProperty.call(e,"closing")&&!e.closing)))}function p(a,p){if("string"!=typeof a)throw void 0===a?new Error("codsen-tokenizer: [THROW_ID_01] the first input argument is completely missing! It should be given as string."):new Error(`codsen-tokenizer: [THROW_ID_02] the first input argument must be string! It was given as "${typeof a}", equal to:\n${JSON.stringify(a,null,4)}`);if(p&&!g(p))throw new Error(`codsen-tokenizer: [THROW_ID_03] the second input argument, an options object, should be a plain object but it was given as type ${typeof p}, equal to ${JSON.stringify(p,null,4)}`);if(p&&g(p)&&p.tagCb&&"function"!=typeof p.tagCb)throw new Error(`codsen-tokenizer: [THROW_ID_04] the opts.tagCb, callback function, should be a function but it was given as type ${typeof p.tagCb}, equal to ${JSON.stringify(p.tagCb,null,4)}`);if(p&&g(p)&&p.charCb&&"function"!=typeof p.charCb)throw new Error(`codsen-tokenizer: [THROW_ID_05] the opts.charCb, callback function, should be a function but it was given as type ${typeof p.charCb}, equal to ${JSON.stringify(p.charCb,null,4)}`);if(p&&g(p)&&p.reportProgressFunc&&"function"!=typeof p.reportProgressFunc)throw new Error(`codsen-tokenizer: [THROW_ID_06] the opts.reportProgressFunc, callback function, should be a function but it was given as type ${typeof p.reportProgressFunc}, equal to ${JSON.stringify(p.reportProgressFunc,null,4)}`);if(p&&g(p)&&p.errCb&&"function"!=typeof p.errCb)throw new Error(`codsen-tokenizer: [THROW_ID_07] the opts.errCb, callback function, should be a function but it was given as type ${typeof p.errCb}, equal to ${JSON.stringify(p.errCb,null,4)}`);const d={...c,...p},h=[],m=[];let y="",f=!1,b={};const v=["tag","comment"],x=["doctype"];return l(a,{reportProgressFunc:d.reportProgressFunc,reportProgressFuncFrom:d.reportProgressFuncFrom,reportProgressFuncTo:d.reportProgressFuncTo,tagCbLookahead:2,tagCb:(l,a)=>{if("function"==typeof d.tagCb&&d.tagCb(l),!l.nested){let c=s.get(m,y);if(g(c)||(c=null),!f||l.closing||c&&c.tagName===l.tagName&&!c.closing&&l.closing||u(h,l)||a.length&&"text"===l.type&&"tag"===a[0].type&&(a[0].closing&&b.closing||h[h.length-3]&&a[0].tagName!==h[h.length-1].tagName&&"tag"===h[h.length-3].type&&!h[h.length-3].closing&&a[0].tagName===h[h.length-3].tagName))if(l.closing&&"string"==typeof y&&y.includes(".")&&(!l.tagName||b.tagName!==l.tagName||b.closing)){if(y=e(t(y)),u(h,l)){for(;h.length&&h[h.length-1].type!==l.type&&h[h.length-1].kind!==l.kind;)h.pop();h.pop(),f=!1}else if(h.length>1&&l.tagName&&l.tagName===h[h.length-2].tagName){if(y=e(t(y)),"function"==typeof d.errCb){const e=h[h.length-1];d.errCb({ruleId:`${e.type}${"comment"===e.type?`-${e.kind}`:""}-missing-closing`,idxFrom:e.start,idxTo:e.end,tokenObj:e})}h.pop(),h.pop()}else if(h.length>2&&h[h.length-3].type===l.type&&h[h.length-3].type===l.type&&h[h.length-3].tagName===l.tagName){if(y=e(t(y)),"function"==typeof d.errCb){const e=h[h.length-1];d.errCb({ruleId:"tag-rogue",idxFrom:e.start,idxTo:e.end,tokenObj:e})}h.pop(),h.pop(),h.pop()}else if(h.length>1&&h[h.length-2].type===l.type&&h[h.length-2].type===l.type&&h[h.length-2].tagName===l.tagName){if("function"==typeof d.errCb){const e=h[h.length-1];d.errCb({ruleId:"tag-rogue",idxFrom:e.start,idxTo:e.end,tokenObj:e})}h.pop(),h.pop()}}else y?(y=e(y),u(h,l)&&h.pop()):y="0";else f=!1,y=`${y}.children.0`;v.includes(l.type)&&!l.void&&Object.prototype.hasOwnProperty.call(l,"closing")&&!l.closing&&(f=!0,l.kind&&x.includes(l.kind)||h.push({...l}));const p=n(y)||"",C=t(y);let F,k;C&&y.includes(".")&&(F=s.get(m,C)),p&&(k=s.get(m,p));const $=/(-+|-+[^>])>/;let N,O;g(k)&&Array.isArray(k.children)&&k.children.length&&k.children[k.children.length-1]&&(N=k.children[k.children.length-1],O=`${p}.children.${s.get(m,p).children.length-1}`);let w=!1;if("text"===l.type&&g(F)&&"comment"===F.type&&"simple"===F.kind&&!F.closing&&$.test(l.value)){const n=($.exec(l.value)||{}).index,r=(n||0)+l.value.slice(n).indexOf(">")+1;n&&n>0&&(s.set(m,y,{...l,end:l.start+n,value:l.value.slice(0,n)}),v.includes(l.type)&&(l.children=[])),y=e(t(y)),s.set(m,y,{type:"comment",kind:"simple",closing:!0,start:l.start+(n||0),end:l.start+r,value:l.value.slice(n,r),children:[]}),r<l.value.length&&(y=e(y),s.set(m,y,{type:"text",start:l.start+r,end:l.end,value:l.value.slice(r)})),w=!0}else if("comment"===l.type&&"only"===l.kind&&g(k))if("text"===k.type&&k.value.trim()&&"<!-".includes(k.value[o(k.value,k.value.length)])){const e=[];if(r(k.value,"\x3c!--",(t=>{e.push(t)}),{maxDistance:2}),e.length&&!i(k.value,e[e.length-1].idxTo-1)){const t=e.pop();!o(k.value,t.idxFrom)&&p&&g(k)?(v.includes(l.type)&&(l.children=[]),y=p,s.set(m,y,{...l,start:t.idxFrom+k.start,kind:"not",value:`${k.value}${l.value}`}),w=!0):p&&g(k)&&(s.set(m,p,{...k,end:t.idxFrom+k.start,value:k.value.slice(0,t.idxFrom)}),v.includes(l.type)&&(l.children=[]),s.set(m,y,{...l,start:t.idxFrom+k.start,kind:"not",value:`${k.value.slice(t.idxFrom)}${l.value}`}),w=!0)}}else if(g(N)&&"text"===N.type&&N.value.trim()&&"<!-".includes(N.value[o(N.value,N.value.length)])){const e=[];if(r(N.value,"\x3c!--",(t=>{e.push(t)}),{maxDistance:2}),e.length&&!i(N.value,e[e.length-1].idxTo-1)){const t=e.pop();!o(N.value,t.idxFrom)&&p&&g(N)?(v.includes(l.type)&&(l.children=[]),s.set(m,y,{...l,start:t.idxFrom+N.start,kind:"not",value:`${N.value}${l.value}`}),s.del(m,`${p}.children.${s.get(m,p).children.length-1}`),w=!0):p&&g(N)&&O&&(s.set(m,O,{...N,end:t.idxFrom+N.start,value:N.value.slice(0,t.idxFrom)}),v.includes(l.type)&&(l.children=[]),s.set(m,y,{...l,start:t.idxFrom+N.start,kind:"not",value:`${N.value.slice(t.idxFrom)}${l.value}`}),w=!0)}}w||(v.includes(l.type)&&(l.children=[]),s.set(m,y,l)),!v.includes(l.type)||!l.closing||p&&g(k)&&!k.closing&&k.type===l.type&&k.tagName===l.tagName||(l.void?"function"==typeof d.errCb&&d.errCb({ruleId:"tag-void-frontal-slash",idxFrom:l.start,idxTo:l.end,fix:{ranges:[[l.start+1,l.tagNameStartsAt]]},tokenObj:l}):"function"==typeof d.errCb&&d.errCb({ruleId:`${l.type}${"comment"===l.type?`-${l.kind}`:""}-missing-opening`,idxFrom:l.start,idxTo:l.end,tokenObj:l})),b={...l}}},charCb:d.charCb}),h.length&&h.forEach((e=>{"function"==typeof d.errCb&&d.errCb({ruleId:`${e.type}${"comment"===e.type?`-${e.kind}`:""}-missing-closing`,idxFrom:e.start,idxTo:e.end,tokenObj:e})})),m}export{p as cparser,c as defaults,a as version};
