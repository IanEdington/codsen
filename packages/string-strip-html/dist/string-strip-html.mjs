/**
 * string-strip-html
 * Strips HTML tags from strings. No parser, accepts mixed sources.
 * Version: 7.0.3
 * Author: Roy Revelt, Codsen Ltd
 * License: MIT
 * Homepage: https://codsen.com/os/string-strip-html/
 */

import e from"lodash.isplainobject";import t from"lodash.trim";import n from"lodash.without";import{decode as r}from"html-entities";import{rApply as s}from"ranges-apply";import{Ranges as a}from"ranges-push";import{right as i}from"string-left-right";function l(e,t){if(!e)return[];if(Array.isArray(e))return e.filter((e=>"string"==typeof e&&e.trim()));if("string"==typeof e)return e.trim()?[e]:[];throw new TypeError(`string-strip-html/stripHtml(): [THROW_ID_03] ${t} must be array containing zero or more strings or something falsey. Currently it's equal to: ${e}, that a type of ${typeof e}.`)}function o(e,t,n){return!e||!e.quotes||!function(e,t,n,r){for(let s=t,a=e.length;a>s;s++){if(e.startsWith(n,s))return!0;if(e.startsWith(r,s))return!1}return!1}(t,n+1,e.quotes.value,">")}var u="7.0.3";const p={ignoreTags:[],onlyStripTags:[],stripTogetherWithTheirContents:["script","style","xml"],skipHtmlDecoding:!1,trimOnlySpaces:!1,dumpLinkHrefsNearby:{enabled:!1,putOnNewLine:!1,wrapHeads:"",wrapTails:""},cb:null};function g(u,m){const c=Date.now(),h=new Set(["!doctype","abbr","address","area","article","aside","audio","base","bdi","bdo","blockquote","body","br","button","canvas","caption","cite","code","col","colgroup","data","datalist","dd","del","details","dfn","dialog","div","dl","doctype","dt","em","embed","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","iframe","img","input","ins","kbd","keygen","label","legend","li","link","main","map","mark","math","menu","menuitem","meta","meter","nav","noscript","object","ol","optgroup","option","output","param","picture","pre","progress","rb","rp","rt","rtc","ruby","samp","script","section","select","slot","small","source","span","strong","style","sub","summary","sup","svg","table","tbody","td","template","textarea","tfoot","th","thead","time","title","tr","track","ul","var","video","wbr","xml"]),d=new Set(["a","b","i","p","q","s","u"]),f=new Set([".",",","?",";",")","…",'"',"»"]),y=[],b=[];let O=[],k={};k={attributes:[]};let A=null,T=null,B={},S={tagName:"",hrefValue:"",openingTagEnds:void 0},C="",v=!1,$=null;function W(e,t,n){if(Array.isArray(t.stripTogetherWithTheirContents)&&(t.stripTogetherWithTheirContents.includes(k.name)||t.stripTogetherWithTheirContents.includes("*")))if(Array.isArray(y)&&y.some((t=>t.name===k.name&&e>t.lastClosingBracketAt))){for(let r=y.length;r--;)if(y[r].name===k.name){(t.stripTogetherWithTheirContents.includes(k.name)||t.stripTogetherWithTheirContents.includes("*"))&&(O=O.filter((([t,n])=>!(t>=y[r].lastOpeningBracketAt&&e+1>t||n>y[r].lastOpeningBracketAt&&e+1>=n))));let s=e+1;k.lastClosingBracketAt&&(s=k.lastClosingBracketAt+1),O.push([y[r].lastOpeningBracketAt,s]),f.has(u[e])&&t.cb?t.cb({tag:k,deleteFrom:y[r].lastOpeningBracketAt,deleteTo:e+1,insert:null,rangesArr:n,proposedReturn:[y[r].lastOpeningBracketAt,e,null]}):t.cb&&t.cb({tag:k,deleteFrom:y[r].lastOpeningBracketAt,deleteTo:e,insert:"",rangesArr:n,proposedReturn:[y[r].lastOpeningBracketAt,e,""]}),y.splice(r,1);break}}else y.push(k)}function w(e,t,n,r,s,a){let i="";if(Number.isInteger(n)&&s>n&&(i+=e.slice(n,s)),Number.isInteger(r)&&r>a+1){const t=e.slice(a+1,r);t.includes("\n")&&"<"===e[r]?i+=" ":i+=t}if(!f.has(e[t])&&"!"!==e[t]){const e=i.match(/\n/g);return Array.isArray(e)&&e.length?1===e.length?"\n":2===e.length?"\n\n":"\n\n\n":" "}return""}function q(e){if(e.dumpLinkHrefsNearby.enabled&&S.tagName&&S.tagName===k.name&&k.lastOpeningBracketAt&&(S.openingTagEnds&&k.lastOpeningBracketAt>S.openingTagEnds||!S.openingTagEnds)&&(v=!0),v){const t=e.dumpLinkHrefsNearby.putOnNewLine?"\n\n":"";C=`${t}${S.hrefValue}${t}`}}if("string"!=typeof u)throw new TypeError(`string-strip-html/stripHtml(): [THROW_ID_01] Input must be string! Currently it's: ${(typeof u).toLowerCase()}, equal to:\n${JSON.stringify(u,null,4)}`);if(m&&!e(m))throw new TypeError(`string-strip-html/stripHtml(): [THROW_ID_02] Optional Options Object must be a plain object! Currently it's: ${(typeof m).toLowerCase()}, equal to:\n${JSON.stringify(m,null,4)}`);function E(){v&&(S={tagName:"",hrefValue:"",openingTagEnds:void 0},v=!1)}const L={...p,...m};if(Object.prototype.hasOwnProperty.call(L,"returnRangesOnly"))throw new TypeError("string-strip-html/stripHtml(): [THROW_ID_03] opts.returnRangesOnly has been removed from the API since v.5 release.");L.ignoreTags=l(L.ignoreTags,"opts.ignoreTags"),L.onlyStripTags=l(L.onlyStripTags,"opts.onlyStripTags");const H=!!L.onlyStripTags.length;if(L.onlyStripTags.length&&L.ignoreTags.length&&(L.onlyStripTags=n(L.onlyStripTags,...L.ignoreTags)),e(L.dumpLinkHrefsNearby)||(L.dumpLinkHrefsNearby={...p.dumpLinkHrefsNearby}),L.dumpLinkHrefsNearby=p.dumpLinkHrefsNearby,m&&Object.prototype.hasOwnProperty.call(m,"dumpLinkHrefsNearby")&&null!=m.dumpLinkHrefsNearby)if(e(m.dumpLinkHrefsNearby))L.dumpLinkHrefsNearby={...p.dumpLinkHrefsNearby,...m.dumpLinkHrefsNearby};else if(m.dumpLinkHrefsNearby)throw new TypeError(`string-strip-html/stripHtml(): [THROW_ID_04] Optional Options Object's key dumpLinkHrefsNearby was set to ${typeof m.dumpLinkHrefsNearby}, equal to ${JSON.stringify(m.dumpLinkHrefsNearby,null,4)}. The only allowed value is a plain object. See the API reference.`);L.stripTogetherWithTheirContents?"string"==typeof L.stripTogetherWithTheirContents&&L.stripTogetherWithTheirContents.length&&(L.stripTogetherWithTheirContents=[L.stripTogetherWithTheirContents]):L.stripTogetherWithTheirContents=[];const N={};if(L.stripTogetherWithTheirContents&&Array.isArray(L.stripTogetherWithTheirContents)&&L.stripTogetherWithTheirContents.length&&!L.stripTogetherWithTheirContents.every(((e,t)=>"string"==typeof e||(N.el=e,N.i=t,!1))))throw new TypeError(`string-strip-html/stripHtml(): [THROW_ID_05] Optional Options Object's key stripTogetherWithTheirContents was set to contain not just string elements! For example, element at index ${N.i} has a value ${N.el} which is not string but ${(typeof N.el).toLowerCase()}.`);L.cb||(L.cb=({rangesArr:e,proposedReturn:t})=>{t&&e.push(...t)});const P=new a({limitToBeAddedWhitespace:!0,limitLinebreaksCount:2});if(!L.skipHtmlDecoding)for(;u!==r(u);)u=r(u);for(let n=0,r=u.length;r>n;n++){if(Object.keys(k).length>1&&k.lastClosingBracketAt&&n>k.lastClosingBracketAt&&" "!==u[n]&&null===$&&($=n),">"===u[n]&&(!k||2>Object.keys(k).length)&&n>1)for(let e=n;e--;)if(void 0===u[e-1]||">"===u[e]){const s=void 0===u[e-1]?e:e+1,a=u.slice(s,n+1);if(u!==`<${t(a.trim(),"/>")}>`&&[...h].some((e=>t(a.trim().split(/\s+/).filter((e=>e.trim())).filter(((e,t)=>0===t)),"/>").toLowerCase()===e))&&""===g(`<${a.trim()}>`,L).result){b.length&&b[b.length-1][0]===k.lastOpeningBracketAt||b.push([s,n+1]),O.length&&O[O.length-1][0]===k.lastOpeningBracketAt||O.push([s,n+1]);const e=w(u,n,s,n+1,s,n+1);let t=n+1;if(u[t]&&!u[t].trim())for(let e=t;r>e;e++)if(u[e].trim()){t=e;break}L.cb({tag:k,deleteFrom:s,deleteTo:t,insert:e,rangesArr:P,proposedReturn:[s,t,e]})}break}if("/"!==u[n]||k.quotes&&k.quotes.value||!Number.isInteger(k.lastOpeningBracketAt)||Number.isInteger(k.lastClosingBracketAt)||(k.slashPresent=n),'"'===u[n]||"'"===u[n])if(k.nameStarts&&k.quotes&&k.quotes.value&&k.quotes.value===u[n]){let e;B.valueEnds=n,B.value=u.slice(B.valueStarts,n),k.attributes.push(B),B={},k.quotes=void 0,L.dumpLinkHrefsNearby.enabled&&k.attributes.some((t=>{if(t.name&&"href"===t.name.toLowerCase())return e=`${L.dumpLinkHrefsNearby.wrapHeads||""}${t.value}${L.dumpLinkHrefsNearby.wrapTails||""}`,!0}))&&(S={tagName:k.name,hrefValue:e,openingTagEnds:void 0})}else!k.quotes&&k.nameStarts&&(k.quotes={},k.quotes.value=u[n],k.quotes.start=n,B.nameStarts&&B.nameEnds&&n>B.nameEnds&&n>B.nameStarts&&!B.valueStarts&&(B.name=u.slice(B.nameStarts,B.nameEnds)));if(!(void 0===k.nameStarts||void 0!==k.nameEnds||u[n].trim()&&(R=u[n],/[-_A-Za-z0-9]/.test(R)))){if(k.nameEnds=n,k.name=u.slice(k.nameStarts,k.nameEnds+(">"!==u[n]&&"/"!==u[n]&&void 0===u[n+1]?1:0)),"!"!==u[k.nameStarts-1]&&!k.name.replace(/-/g,"").length||/^\d+$/.test(k.name[0])){k={};continue}if("<"===u[n]){q(L);const e=w(u,n,k.leftOuterWhitespace,n,k.lastOpeningBracketAt,n);(L.stripTogetherWithTheirContents.includes(k.name)||L.stripTogetherWithTheirContents.includes("*"))&&(O=O.filter((([e,t])=>!(e===k.leftOuterWhitespace&&t===n)))),L.cb({tag:k,deleteFrom:k.leftOuterWhitespace,deleteTo:n,insert:`${e}${C}${e}`,rangesArr:P,proposedReturn:[k.leftOuterWhitespace,n,`${e}${C}${e}`]}),E(),W(n,L,P)}}if(k.quotes&&k.quotes.start&&n>k.quotes.start&&!k.quotes.end&&B.nameEnds&&B.equalsAt&&!B.valueStarts&&(B.valueStarts=n),k.quotes||!B.nameEnds||"="!==u[n]||B.valueStarts||B.equalsAt||(B.equalsAt=n),!k.quotes&&B.nameStarts&&B.nameEnds&&!B.valueStarts&&u[n].trim()&&"="!==u[n]&&(k.attributes.push(B),B={}),k.quotes||!B.nameStarts||B.nameEnds||(u[n].trim()?"="===u[n]?B.equalsAt||(B.nameEnds=n,B.equalsAt=n,B.name=u.slice(B.nameStarts,B.nameEnds)):("/"===u[n]||">"===u[n]||"<"===u[n])&&(B.nameEnds=n,B.name=u.slice(B.nameStarts,B.nameEnds),k.attributes.push(B),B={}):(B.nameEnds=n,B.name=u.slice(B.nameStarts,B.nameEnds))),k.quotes||k.nameEnds>=n||u[n-1].trim()||!u[n].trim()||"<>/!".includes(u[n])||B.nameStarts||k.lastClosingBracketAt||(B.nameStarts=n),null!==k.lastOpeningBracketAt&&n>k.lastOpeningBracketAt&&"/"===u[n]&&k.onlyPlausible&&(k.onlyPlausible=!1),null!==k.lastOpeningBracketAt&&n>k.lastOpeningBracketAt&&"/"!==u[n]&&(void 0===k.onlyPlausible&&(k.onlyPlausible=!(u[n].trim()&&"<"!==u[n]||k.slashPresent)),u[n].trim()&&void 0===k.nameStarts&&"<"!==u[n]&&"/"!==u[n]&&">"!==u[n]&&"!"!==u[n]&&(k.nameStarts=n,k.nameContainsLetters=!1)),k.nameStarts&&!k.quotes&&u[n].toLowerCase()!==u[n].toUpperCase()&&(k.nameContainsLetters=!0),">"===u[n]&&o(k,u,n)&&void 0!==k.lastOpeningBracketAt&&(k.lastClosingBracketAt=n,$=null,Object.keys(B).length&&(k.attributes.push(B),B={}),L.dumpLinkHrefsNearby.enabled&&S.tagName&&!S.openingTagEnds&&(S.openingTagEnds=n)),void 0!==k.lastOpeningBracketAt)if(void 0===k.lastClosingBracketAt){if(n>k.lastOpeningBracketAt&&"<"!==u[n]&&(void 0===u[n+1]||"<"===u[n+1])&&k.nameContainsLetters){if(k.name=u.slice(k.nameStarts,k.nameEnds?k.nameEnds:n+1).toLowerCase(),b.length&&b[b.length-1][0]===k.lastOpeningBracketAt||b.push([k.lastOpeningBracketAt,n+1]),L.ignoreTags.includes(k.name)||k.onlyPlausible&&!h.has(k.name)){k={},B={};continue}if((h.has(k.name)||d.has(k.name))&&(!1===k.onlyPlausible||!0===k.onlyPlausible&&k.attributes.length)||void 0===u[n+1]){q(L);const e=w(u,n,k.leftOuterWhitespace,n+1,k.lastOpeningBracketAt,k.lastClosingBracketAt);L.cb({tag:k,deleteFrom:k.leftOuterWhitespace,deleteTo:n+1,insert:`${e}${C}${e}`,rangesArr:P,proposedReturn:[k.leftOuterWhitespace,n+1,`${e}${C}${e}`]}),E(),W(n,L,P)}if(!O.length||O[O.length-1][0]!==k.lastOpeningBracketAt&&O[O.length-1][1]!==n+1)if(L.stripTogetherWithTheirContents.includes(k.name)||L.stripTogetherWithTheirContents.includes("*")){let e;for(let t=y.length;t--;)y[t].name===k.name&&(e=y[t]);e?(O=O.filter((([t])=>t!==e.lastOpeningBracketAt)),O.push([e.lastOpeningBracketAt,n+1])):O.push([k.lastOpeningBracketAt,n+1])}else O.push([k.lastOpeningBracketAt,n+1])}}else if(n>k.lastClosingBracketAt&&u[n].trim()||void 0===u[n+1]){let e=k.lastClosingBracketAt===n?n+1:n;if(L.trimOnlySpaces&&e===r-1&&null!==$&&n>$&&(e=$),b.length&&b[b.length-1][0]===k.lastOpeningBracketAt||b.push([k.lastOpeningBracketAt,k.lastClosingBracketAt+1]),!H&&L.ignoreTags.includes(k.name)||H&&!L.onlyStripTags.includes(k.name))L.cb({tag:k,deleteFrom:null,deleteTo:null,insert:null,rangesArr:P,proposedReturn:null}),k={},B={};else if(!k.onlyPlausible||0===k.attributes.length&&k.name&&(h.has(k.name.toLowerCase())||d.has(k.name.toLowerCase()))||k.attributes&&k.attributes.some((e=>e.equalsAt))){O.length&&O[O.length-1][0]===k.lastOpeningBracketAt||O.push([k.lastOpeningBracketAt,k.lastClosingBracketAt+1]);const t=w(u,n,k.leftOuterWhitespace,e,k.lastOpeningBracketAt,k.lastClosingBracketAt);let r;C="",v=!1,q(L),r="string"==typeof C&&C.length?`${t}${C}${"\n\n"===t?"\n":t}`:t,0!==k.leftOuterWhitespace&&i(u,e-1)||(r=""),L.cb({tag:k,deleteFrom:k.leftOuterWhitespace,deleteTo:e,insert:r,rangesArr:P,proposedReturn:[k.leftOuterWhitespace,e,r]}),E(),W(n,L,P)}else k={};">"!==u[n]&&(k={})}if("<"===u[n]&&"<"!==u[n-1]&&!"'\"".includes(u[n+1])&&(!"'\"".includes(u[n+2])||/\w/.test(u[n+1]))&&("c"!==u[n+1]||":"!==u[n+2])&&("%"!==u[n+1]||"@"!==u[n+2])&&("f"!==u[n+1]||"m"!==u[n+2]||"t"!==u[n+3]||":"!==u[n+4])&&("s"!==u[n+1]||"q"!==u[n+2]||"l"!==u[n+3]||":"!==u[n+4])&&("x"!==u[n+1]||":"!==u[n+2])&&("f"!==u[n+1]||"n"!==u[n+2]||":"!==u[n+3])&&o(k,u,n)){if(">"===u[i(u,n)])continue;if(k.nameEnds&&n>k.nameEnds&&!k.lastClosingBracketAt&&(!0===k.onlyPlausible&&k.attributes&&k.attributes.length||!1===k.onlyPlausible)){const e=w(u,n,k.leftOuterWhitespace,n,k.lastOpeningBracketAt,n);L.cb({tag:k,deleteFrom:k.leftOuterWhitespace,deleteTo:n,insert:e,rangesArr:P,proposedReturn:[k.leftOuterWhitespace,n,e]}),W(n,L,P),k={},B={}}if(void 0!==k.lastOpeningBracketAt&&k.onlyPlausible&&k.name&&!k.quotes&&(k.lastOpeningBracketAt=void 0,k.name=void 0,k.onlyPlausible=!1),!(void 0!==k.lastOpeningBracketAt&&k.onlyPlausible||k.quotes)&&(k.lastOpeningBracketAt=n,k.slashPresent=!1,k.attributes=[],k.leftOuterWhitespace=null===A?n:L.trimOnlySpaces&&0===A?T||n:A,"!--"==`${u[n+1]}${u[n+2]}${u[n+3]}`||"![CDATA["==`${u[n+1]}${u[n+2]}${u[n+3]}${u[n+4]}${u[n+5]}${u[n+6]}${u[n+7]}${u[n+8]}`)){let e,t=!0;"-"===u[n+2]&&(t=!1);for(let s=n;r>s;s++)if((!e&&t&&"]]>"==`${u[s-2]}${u[s-1]}${u[s]}`||!t&&"--\x3e"==`${u[s-2]}${u[s-1]}${u[s]}`)&&(e=s),e&&(s>e&&u[s].trim()||void 0===u[s+1])){let t=s;(void 0===u[s+1]&&!u[s].trim()||">"===u[s])&&(t+=1),b.length&&b[b.length-1][0]===k.lastOpeningBracketAt||b.push([k.lastOpeningBracketAt,e+1]),O.length&&O[O.length-1][0]===k.lastOpeningBracketAt||O.push([k.lastOpeningBracketAt,e+1]);const r=w(u,s,k.leftOuterWhitespace,t,k.lastOpeningBracketAt,e);L.cb({tag:k,deleteFrom:k.leftOuterWhitespace,deleteTo:t,insert:r,rangesArr:P,proposedReturn:[k.leftOuterWhitespace,t,r]}),n=s-1,">"===u[s]&&(n=s),k={},B={};break}}}""===u[n].trim()?null===A&&(A=n,void 0!==k.lastOpeningBracketAt&&n>k.lastOpeningBracketAt&&k.nameStarts&&k.lastOpeningBracketAt>k.nameStarts&&n===k.lastOpeningBracketAt+1&&!y.some((e=>e.name===k.name))&&(k.onlyPlausible=!0,k.name=void 0,k.nameStarts=void 0)):null!==A&&(!k.quotes&&B.equalsAt>A-1&&B.nameEnds&&B.equalsAt>B.nameEnds&&'"'!==u[n]&&"'"!==u[n]&&(e(B)&&k.attributes.push(B),B={},k.equalsSpottedAt=void 0),A=null)," "===u[n]?null===T&&(T=n):null!==T&&(T=null)}var R;if(u&&(L.trimOnlySpaces&&" "===u[0]||!L.trimOnlySpaces&&!u[0].trim()))for(let e=0,t=u.length;t>e;e++){if(L.trimOnlySpaces&&" "!==u[e]||!L.trimOnlySpaces&&u[e].trim()){P.push([0,e]);break}u[e+1]||P.push([0,e+1])}if(u&&(L.trimOnlySpaces&&" "===u[u.length-1]||!L.trimOnlySpaces&&!u[u.length-1].trim()))for(let e=u.length;e--;)if(L.trimOnlySpaces&&" "!==u[e]||!L.trimOnlySpaces&&u[e].trim()){P.push([e+1,u.length]);break}const x=P.current();if((!m||!m.cb)&&x){if(x[0]&&!x[0][0]){P.ranges[0]=[P.ranges[0][0],P.ranges[0][1]]}if(x[x.length-1]&&x[x.length-1][1]===u.length){if(P.ranges){let e=P.ranges[P.ranges.length-1][0];u[e-1]&&(L.trimOnlySpaces&&" "===u[e-1]||!L.trimOnlySpaces&&!u[e-1].trim())&&(e-=1);const t=P.ranges[P.ranges.length-1][2];P.ranges[P.ranges.length-1]=[e,P.ranges[P.ranges.length-1][1]],t&&t.trim()&&P.ranges[P.ranges.length-1].push(function(e){return e.replace(RegExp(/[\x09\x0A\x0B\x0C\x0D\x20\xA0\u1680\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200A\u202F\u205F\u3000\u2028\u2029\uFEFF]+/.source+"$","g"),"")}(t))}}}return{log:{timeTakenInMilliseconds:Date.now()-c},result:s(u,P.current()),ranges:P.current(),allTagLocations:b,filteredTagLocations:O}}export{p as defaults,g as stripHtml,u as version};
